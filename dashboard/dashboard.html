<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<! 


    THIS FILE IS JUST A PLACEHOLDER FOR A REAL IMPLEMENTATION.

    It was just copied over from Sequel.  The actually implementation will
    poll wx-daemon's HTTP/REST interface and display the information in 
    tabular or graphical format.  The code here is an example of how to 
    write in Jquery and Javascript.

>
<head>
    <meta charset="utf-8" />
    <title>Primary Analysis</title>

    <!--

    <link rel="stylesheet" type="text/css" href="css/pa.css">
    <link rel="stylesheet" type="text/css" href="css/epoch.min.css">
    -->

    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/epoch.min.js"></script>

</head>
<body>
    <h1>PA WS Status Panel</h1>
    <!-- some more ideas http://code.shutterstock.com/rickshaw/examples/ -->
    <div id="baseport">baseport</div>

    <p>
    </p>

    <div class="list-row">
        <div class="list-left">
            
            <table border="1" id="mybody">
                <tr><th></th><th>1</th><th>2</th><th>3</th><th>4</th></tr>
                <tr><td>DARKCAL</td></tr>
                <tr><td>Execution Status</td><td id="darkcal1_executionStatus"> ? </td>   <td id="darkcal2_executionStatus"> ? </td>  <td id="darkcal3_executionStatus"> ? </td>  <td id="darkcal4_executionStatus"> ? </td></tr>
                <tr><td>Completion Status</td><td id="darkcal1_completionStatus"> ? </td> <td id="darkcal2_completionStatus"> ? </td> <td id="darkcal3_completionStatus"> ? </td> <td id="darkcal4_completionStatus"> ? </td></tr>
                <tr><td>Armed</td><td id="darkcal1_armed"> ? </td>                        <td id="darkcal2_armed"> ? </td>            <td id="darkcal3_armed"> ? </td>            <td id="darkcal4_armed"> ? </td></tr>
                <tr><td>Timestamp</td><td id="darkcal1_timestamp"> ? </td>                <td id="darkcal2_timestamp"> ? </td>        <td id="darkcal3_timestamp"> ? </td>        <td id="darkcal4_timestamp"> ? </td></tr>
                <tr><td>movieMaxFrames</td><td id="darkcal1_maxMovieFrames"> ? </td>      <td id="darkcal2_maxMovieFrames"> ? </td>   <td id="darkcal3_maxMovieFrames"> ? </td>   <td id="darkcal4_maxMovieFrames"> ? </td></tr>
                <tr><td>MID</td><td id="darkcal1_mid"> ? </td>                            <td id="darkcal2_mid"> ? </td>              <td id="darkcal3_mid"> ? </td>              <td id="darkcal4_mid"> ? </td></tr>
                <tr><td>Progress</td><td id="darkcal1_netProgress"> ? </td>               <td id="darkcal2_netProgress"> ? </td>      <td id="darkcal3_netProgress"> ? </td>      <td id="darkcal4_netProgress"> ? </td></tr>
                <tr><td>Stage</td><td id="darkcal1_stageName"> ? </td>                    <td id="darkcal2_stageName"> ? </td>        <td id="darkcal3_stageName"> ? </td>        <td id="darkcal4_stageName"> ? </td></tr>
                <tr><td>LOADING CAL</td></tr>

                <tr><td>BASECALLER></td></tr>
                <tr><td>Execution Status</td><td id="basecaller1_executionStatus"> ? </td> <td id="basecaller2_executionStatus"> ? </td>  <td id="basecaller3_executionStatus"> ? </td>  <td id="basecaller4_executionStatus"> ? </td></tr>
                <tr><td>Complete Status</td><td id="basecaller1_completionStatus"> ? </td> <td id="basecaller2_completionStatus"> ? </td> <td id="basecaller3_completionStatus"> ? </td> <td id="basecaller4_completionStatus"> ? </td></tr>
                <tr><td>Armed</td><td id="basecaller1_armed"> ? </td>                      <td id="basecaller2_armed"> ? </td>            <td id="basecaller3_armed"> ? </td>            <td id="basecaller4_armed"> ? </td></tr>
                <tr><td>Timestamp</td><td id="basecaller1_timestamp"> ? </td>              <td id="basecaller2_timestamp"> ? </td>        <td id="basecaller3_timestamp"> ? </td>        <td id="basecaller4_timestamp"> ? </td></tr>
                <tr><td>MID</td><td id="basecaller1_mid"> ? </td>                          <td id="basecaller2_mid"> ? </td>              <td id="basecaller3_mid"> ? </td>              <td id="basecaller4_mid"> ? </td></tr>
                <tr><td>Progress</td><td id="basecaller1_netProgress"> ? </td>             <td id="basecaller2_netProgress"> ? </td>      <td id="basecaller3_netProgress"> ? </td>      <td id="basecaller4_netProgress"> ? </td></tr>
                <tr><td>Stage</td><td id="basecaller1_stageName"> ? </td>                  <td id="basecaller2_stageName"> ? </td>        <td id="basecaller3_stageName"> ? </td>        <td id="basecaller4_stageName"> ? </td></tr>


<!--     "basecaller": {
        "uuid": "",
        "bazUrl": "",
        "traceFileUrl": "",
        "chiplayout": "",
        "darkcalFileUrl": "",
        "pixelSpreadFunction": null,
        "crosstalkFilter": null,
        "analogs": null,
        "sequencingRoi": null,
        "traceFileRoi": null,
        "expectedFrameRate": 0,
        "photoelectronSensitivity": 0,
        "refSnr": 0,
        "simulationFileUrl": "",
        "smrtBasecallerConfig": "",
        "RtMetrics": {
            "url": ""
        },
        "mid": "",
        "maxMovieFrames": 0,
        "maxMovieSeconds": 0,
        "movieNumber": 0,
        "logUrl": "",
        "logLevel": "",
        "processStatus": {
            "executionStatus": "",
            "completionStatus": "",
            "timestamp": "",
            "exitCode": 0,
            "PID": 0
        }
    } 
 -->



            </table>
        </div>
        <div class="list-left">
            ppad Post Primary
            <table border="1">
                <tr><th></th><th>HOST</th></tr>
                <tr><td>State</td><td id="ppadState"> ? </td></tr>
                <tr><td>Timestamp</td><td id="ppadTimeStatus"> ? </td></tr>
                <tr><td>Uptime</td><td id="ppadUptime"> ? </td></tr>
                <tr><td>AcqId</td><td id="ppadAcqId"> ? </td></tr>
                <tr><td>Message</td><td id="ppadMessage"> ? </td></tr>
                <tr><td>Progress (%)</td><td id="ppadProgress"> ? </td></tr>
            </table>
        </div>
    </div>
    <div id="errorMessages"></div>
    <input type="checkbox" id="isShowAllAlarmsSelected">Show All Alarms</input>

    <div class="list-left">
        Versions
        <table border="1">
            <tr><td>pa-ws   </td> <td id="pawsVersion"> ? </td></tr>
            <tr><td>pa-acq  </td> <td id="wxVersion"> ? </td></tr>
            <tr><td>pa-t2b@0</td> <td id="basecallerVersion"> ? </td></tr>
        </table>
    </div>


    <p>
    </p>
    <script type="text/javascript">
        var previousTranches = [0,0,0];
        pawsHost = "rt-84003"; // window.location.hostname;
        ppadHost = ""; // window.location.hostname;
        platform = "UNKNOWN";
        $.urlParam = function(name){
            var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
            if (results==null){
                return null;
            }
            else{
                return results[1] || 0;
            }
        }

        $(function () {
            var baseport=$.urlParam("baseport");
            if (baseport == null)
            {
                baseport = location.port.substring(0,location.port.length - 2);
                baseport = parseInt(baseport)*100; // take current and round down to nearest block of 100
            } else
            {
                baseport = parseInt(baseport);
            }
            $('#baseport')[0].innerText = window.location.hostname +":" + baseport;
            console.log("baseport=%d ",baseport)

            function timeStatus(field,t) {
                tt = new Date(t * 1000);
                now = Date.now();
                diff = now.valueOf() - tt.valueOf();
                if (diff > 15000) {
                    $(field)[0].style.backgroundColor = "red";
                }
                else {
                    $(field)[0].style.backgroundColor = "white"; // $('#mybody').style.backgroundColor
                }
                return tt.toString().match(" [0-9]+:[0-9]{2}:[0-9]{2} ");
            }
            function convertTime(time) {
                var seconds = parseInt(time % 60);
                time = parseInt(time/60);
                var minutes = time % 60;
                time = parseInt(time/60);
                var hours = time % 24;
                time = parseInt(time/24);
                var days = time % 24;
                var out = "";
                if(days > 0) out += days + "d ";
                if(hours > 0) out += hours + "h ";
                if(minutes > 0) out += minutes + "m "
                if(seconds > 0) out += seconds + "s ";
                return out.trim();
            }

            function colorState(field,state)
            {
                if (state == null || state == "error" || state == "Error" || state.includes("Failed")) {
                    $(field)[0].style.backgroundColor = "red";
                }
                else if(state == "boot")
                {
                    $(field)[0].style.backgroundColor = "yellow";
                }
                else if(state == "offline")
                {
                    $(field)[0].style.backgroundColor = "gray";
                }
                else {
                    $(field)[0].style.backgroundColor = "lightgreen";
                }

            }
            function onDataReceivedSocket(json1, socket) {
                darkcal = json1.darkcal;
                tag = '#darkcal'+socket
                $(tag + '_executionStatus')[0].innerText = darkcal.processStatus.executionStatus;
                $(tag+'_completionStatus')[0].innerText = darkcal.processStatus.completionStatus;
                $(tag+'_timestamp')[0].innerText = darkcal.processStatus.timestamp;
                $(tag+'_mid')[0].innerText = darkcal.mid;
                $(tag+'_armed')[0].innerText = darkcal.processStatus.armed;
                $(tag+'_netProgress')[0].innerText =darkcal.processStatus.Progress.netProgress;
                $(tag+'_stageName')[0].innerText =darkcal.processStatus.Progress.stageName;
                $(tag+'_maxMovieFrames')[0].innerText = darkcal.maxMovieFrames;
                colorState(tag+'_executionStatus', darkcal.processStatus.executionStatus);

                basecaller = json1.basecaller
                tag = '#basecaller'+socket
                $(tag+'_executionStatus')[0].innerText = basecaller.processStatus.executionStatus;
                $(tag+'_completionStatus')[0].innerText = basecaller.processStatus.completionStatus;
                $(tag+'_timestamp')[0].innerText = basecaller.processStatus.timestamp;
                $(tag+'_mid')[0].innerText = basecaller.mid;
                $(tag+'_armed')[0].innerText = basecaller.processStatus.armed;
                $(tag+'_netProgress')[0].innerText =basecaller.processStatus.Progress.netProgress;
                $(tag+'_stageName')[0].innerText =basecaller.processStatus.Progress.stageName;

                colorState(tag+'_executionStatus', basecaller.processStatus.executionStatus);

/*                 $('#acqVersion')[0].innerText = json.version;
                $('#acqTimeStatus')[0].innerText = timeStatus('#acqTimeStatus', parseFloat(json.time));
                $('#acqUptime')[0].innerText = convertTime(json.uptime);
                $('#acqLoad')[0].innerText = parseFloat(json.load1m);
                $('#acqChipClass')[0].innerText = json.chipClass;
                $('#auroraStatus')[0].innerText = json.auroraStatus;
                if (json.auroraStatus == "up") {
                    $('#auroraStatus')[0].style.backgroundColor = "lightgreen";
                } else if (json.auroraStatus == "na") {
                    $('#auroraStatus')[0].style.backgroundColor = "white";
                } else {
                    $('#auroraStatus')[0].style.backgroundColor = "red";
                }
                // $('#transmitFrame')[0].innerText = parseInt(json.transmitFrame).toLocaleString();
                if (json.movieTransmitterFrameIndex >= 18446744073709552000) {
                    $('#transmitStatus')[0].innerText = json.transmitStatus + " index: none sent";
                } else {
                    $('#transmitStatus')[0].innerText = json.transmitStatus + " index:" + json.movieTransmitterFrameIndex;
                }
                $('#currentFrame')[0].innerText = parseInt(json.currentFrame).toLocaleString() + " index:" + json.currentFrameIndex;
                $('#movieFrame')[0].innerText = parseInt(json.movieFrame).toLocaleString();
                $('#acqToken')[0].innerText = json.token;

                $('#freeTilePercent')[0].innerText = json.freeTilePercent;

                if (json1.warning) {
                    $('#pduOverflows')[0].innerText = json1.warning.rxOverflowPduCount;
                    $('#crcErrors')[0].innerText = json1.warning.rxGthCrcErrorCount;
                }
                else {
                    $('#pduOverflows')[0].innerText = 0;
                    $('#crcErrors')[0].innerText = 0;
                }
                if (json1.fpga) {
                    $('#tlbProcInvCnt')[0].innerText = json1.fpga.tlbProcInvCnt;
                }
                $('#tilesOwnedByFpga')[0].innerText = json1.tilesOwnedByFpga;
                $('#acqSentDeeds')[0].innerText = json.sentDeeds;
                $('#acqFractionOfChunk')[0].innerText = json.fractionOfChunk;
                $('#acqFractionOfSuperChunk')[0].innerText = json.fractionOfSuperChunk;
 */
                hoursLeft
                d = [
                    { time: parseInt(json.time), y: parseFloat(json.frameRate) },
                    { time: parseInt(json.time), y: parseFloat(json.freeTilePercent) },
                    { time: parseInt(json.time), y: parseFloat(json.fractionOfChunk)*100.0 },
                    { time: parseInt(json.time), y: parseFloat(json.fractionOfSuperChunk)*100.0 },
                ];
                chartAcq.push(d);

//                console.warn(json);
            }

            function onDataReceivedPpad(json) {
                $('#ppadAcqId')[0].innerText    = json.acqId ;
                $('#ppadVersion')[0].innerText = json.version;
                $('#ppadTimeStatus')[0].innerText = timeStatus('#ppadTimeStatus',parseFloat(json.time));
                $('#ppadUptime')[0].innerText = convertTime(json.uptime);
                $('#ppadMessage')[0].innerText  = json.message ;
                $('#ppadProgress')[0].innerText = json.progress ;
                $('#ppadState')[0].innerText    = json.state;
                colorState('#ppadState',json.state);
                //"acqId": "eab96191-427c-4edb-8932-ceb70e146966","message": "","progress": "70","state": "busy","version": "4.1.0.0"}
                // "message": "Status Service are up and running for 250871 seconds.",
            }
            function onDataReceivedPawsStatus(json) {
                //$('#pawsState')[0].innerText = json.state;
                //colorState('#pawsState',json.state);
                $('#pawsVersion')[0].innerText = json.version;
                $('#pawsTimeStatus')[0].innerText = timeStatus('#pawsTimeStatus',parseFloat(json.time));
                $('#pawsUptime')[0].innerText = convertTime(json.uptime);
            }
            function onDataFailure(jqXHR, textStatus, errorThrown) {
                console.warn(jqXHR);
                var fp = $('#errorMessages')[0];
                fp.innerText = jqXHR.responseText
                //r = jQuery.parseJSON(jqXHR.responseText);
                //fp.innerText = r.Message + r.StackTrace + r.ExceptionType;
            }

            function onSockets(sockets) {
                sockets.forEach( function(socket) {
                    $.ajax({
                        url: "http://"+ pawsHost + ":" + (baseport +32) + "/sockets/" + socket,
                        method: 'GET',
                        dataType: 'json',
                        contentType: "application/json",
                        success: function(json) { onDataReceivedSocket(json,socket) },
                        error: function(a,b,c) {
                            onDataFailure(a, b, c);
                            $('#acqTimeStatus')[0].style.backgroundColor = "red";
                        }
                    });
                })
            }

            setInterval(function () {
                $.ajax({
                    url: "http://"+ pawsHost + ":" + (baseport +32) + "/sockets",
                    method: 'GET',
                    dataType: 'json',
                    contentType: "application/json",
                    success: onSockets
                });
            }, 1000);

/*             setInterval(function () {
                if (ppadHost !== "") {
                    $.ajax({
                        url: "http://" + ppadHost + ":" + (baseport + 62) + "/",
                        method: 'GET',
                        dataType: 'json',
                        contentType: "application/json",
                        success: onDataReceivedPpad,
                        error: onDataFailure
                    });
                }
            }, 1000);

            setInterval(function () {
                if (pawsHost !== "") {
                    $.ajax({
                        url: "http://" + pawsHost + ":8091/status",
                        method: 'GET',
                        dataType: 'json',
                        contentType: "application/json",
                        success: onDataReceivedPawsStatus,
                        error: onDataFailure
                    });
                }
            }, 1000); */

        });


    </script>
</body>
</html>
